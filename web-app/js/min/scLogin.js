isc.ClassFactory.defineClass("SmartOTPLoginDialog","LoginDialog").addProperties({autoDraw:!0,firstLogin:!1,relogin:!1,usernameItemProperties:{visible:!1},items:["autoChild:headerHelp","autoChild:headerImage","autoChild:timerBar","autoChild:loginForm"],headerImageDefaults:{_constructor:isc.Img,width:"100%",imageType:"normal",imageWidth:0,imageHeight:0,visibility:"hidden"},headerHelpDefaults:{_constructor:isc.HTMLFlow,padding:5,width:"100%",visibility:"hidden"},timerBarDefaults:{_constructor:isc.Progressbar,
showTitle:!1,breadth:10,percentDone:100},loginFailureItemProperties:{wrap:!0},refreshTitle:function(){this.setTitle(isc.i18nMessages["smartsfs.security.otp.title"]+" "+isc.DateUtil.format(this.getServerDateTime(),"dd.MM.yyyy HH:mm:ss"));var a=this.getServerDateTime().valueOf()/1E3;this.timerBar.setPercentDone(100-Math.floor(100*(a/this.timeTrip-Math.floor(a/this.timeTrip))));this.delayCall("refreshTitle")},getServerDateTime:function(){var a=Date.create();localTimeOffset&&(a=new Date(Date.create().valueOf()+
localTimeOffset));return a},initWidget:function(){this.title=isc.i18nMessages["smartsfs.security.otp.title"]+" "+isc.DateUtil.format(this.getServerDateTime(),"dd.MM.yyyy HH:mm:ss");this.errorMessage=isc.i18nMessages["smartsfs.security.otp.failure"];this.passwordItemTitle=isc.i18nMessages["smartsfs.security.otp.password.title"];this.loginButtonTitle=isc.i18nMessages["smartsfs.security.otp.button.title"];this.timeTrip=NumberUtil.parseInt(App.get.config["smartsfs.security.otp.roundbysec"]);this.passwordItemProperties=
{wrapTitle:!1,clipTitle:!1,type:"text"};this.headerIconProperties={src:"[SKIN]/custom/QRkey.png"};if(1==this.firstLogin){var a=contextRoot+"/tmp/loginQR"+App.get.user.username+"_"+App.get.user.qr+".png";isc.i18nMessages["smartsfs.security.otp.qrcode.help"]&&(this.headerHelpProperties={contents:isc.i18nMessages["smartsfs.security.otp.qrcode.help"],visibility:"visible"});this.headerImageProperties=isc.Browser.isDesktop?{imageWidth:250,imageHeight:250,src:a,visibility:"visible"}:{imageWidth:150,imageHeight:150,
src:a,visibility:"visible"}}this.Super("initWidget",arguments);this.delayCall("refreshTitle")},loginFunc:function(a,b){var c=this;null!=a&&(a.j_username=a.username,a.j_password=a.password,a.ajax=!0,App.dataRequest(App.loginRequestUrl,a,function(a,d,e){d&&(d.success?App.dataRequest(App.userRequestUrl,{username:d.username},function(a,d){App.get.user=SmartUser.create(d.response.data);b(!0);1!=c.relogin?App.get.createAppLayout():isc.isA.Function(c.reloginCbk)&&c.reloginCbk()}):(App.get.user=void 0,b(!0),
isc.warn(c.loginDialog.errorMessage,function(){App.get.loginUser()})))},!0))}});isc.showOTPDialog=function(a,b,c){a=SmartOTPLoginDialog.create({firstLogin:a});a.loginForm.relogin=b;a.loginForm.reloginCbk=c;a.timerBar.setLength(a.getVisibleWidth()-a.layoutRightMargin-a.layoutLeftMargin);a.timerBar.setBreadth(10);a.headerHelp.setWidth(a.timerBar.getLength());a.loginForm.getItem("passwordItem").focusInItem();return a};
isc.showUserQRCode=function(a,b,c){b=contextRoot+"/tmp/loginQR"+a+"_"+b+".png";a=0;a=isc.Browser.isDesktop?250:150;b=isc.Window.create({headerIconProperties:{src:"[SKIN]/custom/QRkey.png"},title:isc.i18nMessages["smartsfs.security.otp.showQR.title"],items:isc.Img.create({width:"100%",height:"100%",imageWidth:a,imageHeight:a,src:b,visibility:"visible",snapToGrid:!0,snapResizeToGrid:!0}),showCloseButton:!0,canDragResize:!0,isModal:!0,showModalMask:!0,dismissOnEscape:!0,dismissOnOutsideClick:!0,autoCenter:!0,
closeCbk:function(){isc.isA.Function(c)&&c()}});b.observe(b,"close","observer.closeCbk()");b.resizeTo(a,a);b.redraw();b.show()};
